# Create Anything - Dating App

## Overview
This project is a feature-rich dating/matching application providing video calling, messaging, scheduling, and media uploads. It aims to deliver a robust and scalable platform focused on user engagement and seamless communication. The business vision is to capture a significant share of the online dating market by offering a superior user experience and advanced features not commonly found in competitors, thereby driving high user retention and monetization through a tiered membership model.

## User Preferences
I prefer detailed explanations and iterative development. Ask before making major changes. I value clear communication regarding the agent's actions and decisions.

## System Architecture
The application utilizes a client-server architecture with a React 18 frontend employing React Router 7 for navigation and TailwindCSS for styling, featuring a mobile-first UI/UX with Tinder-style profile cards and gradient overlays. Routing uses Next.js-style route grouping. The backend is built with Hono (Node.js) and interacts with a PostgreSQL database. Auth.js handles authentication. Key features include Discovery, Matches, Messages with real-time chat, Profile management, and a consolidated onboarding flow. An `ErrorBoundary` ensures graceful error handling.

The system incorporates a 4-tier membership model (Free, Casual, Dating, Business) governing media limits, chat durations, and meeting caps, enforced both client-side and via backend API. A real-time video call extension system allows paid extensions with synchronized timers. Safety features include a 4-strike moderation logic. Core features include smart matching with prioritization, mutual interests highlighting, activity-based matching, conversation starters, Daily Picks, and Reverse Discovery (profile viewers). Media management supports photo uploads and camera-only video recording with tier-based limits. Revenue-protection downgrade flows are implemented for subscription management.

**Authentication Flow (November 1, 2025):** The application implements comprehensive global authentication protection across all routes:

**Global Authentication Guard** (`_layout.jsx`): Runs on EVERY navigation event using Expo Router's `usePathname()` and `useSegments()` hooks. The guard protects all routes except defined public pages, redirecting unauthenticated users attempting to access protected content to `/welcome`. Public routes include: `/welcome`, all `/onboarding/*` pages. All other routes (discovery, matches, messages, profile viewing, settings, video calls) require authentication.

**Step 1 - Authentication Check** (Index `/`): Backend-first authentication query (compatible with QA_BYPASS and real sessions). Uses absolute URL with AbortController timeout (5s) to prevent cold-start hangs. 401 response routes to `/welcome` (Sign-In page). Success proceeds to Step 2.

**Step 2 - Onboarding Completion Check** (Index `/`): Sequential gates validate consent acceptance, membership tier selection, and profile completion (name + 2 photos minimum). Incomplete onboarding routes to first missing step. Complete onboarding routes to `/discovery` (Main Application Dashboard).

**Welcome Back Page** (`/welcome`): Universal entry point for unauthenticated users with "Sign In" and "Join Now" CTAs. Auto-redirects when authenticated.

**Error Handling:** Distinguishes true unauthenticated state (401) from server errors (5xx), timeout errors from network errors, provides graceful degradation, prevents authentication loops.

**Discovery-First UX:** Returning users with complete onboarding land directly on Discovery page (matching system), ready to start connecting. Deep links and page reloads to protected routes are properly guarded and redirect unauthenticated users to welcome page.

UX enhancements include optimistic UI updates for immediate feedback, `ErrorBoundary` components for critical sections, and loading skeletons for improved perceived performance. Security measures include webhook monitoring, idempotency keys for payment processing, database-backed rate limiting on critical endpoints, and database constraints for data integrity. A unified pricing structure is sourced from configuration.

Data integrity and performance are managed through database indexes on frequently accessed tables and central configuration of all limits, thresholds, and pricing. A client-side session monitor ensures secure session management.

Code quality and scalability are maintained through comprehensive Vitest integration tests that interact with real API routes and databases, a full TypeScript migration of payment endpoints for type safety, a production-ready feature flag system for dynamic control, and structured logging for business events.

User experience features include a private user notes system for recording observations about matches, with integration points in post-call modals and chat. Admin features include a user photo management dashboard with search, filtering, and moderation status highlighting.

A hybrid chat monetization system uses a three-pool message deduction (first-encounter bonuses, daily tier allowances, purchased credits) with per-match caps for the Business tier. Video call completion incentives messaging, and credit packs are available for purchase. A real-time quota UI displays remaining messages.

The mobile app upload system uses base64 encoding for media uploads, resolving compatibility issues. Video recording limits are tier-based. A unified `/api/upload-base64` endpoint handles various input types. The profile onboarding UX includes photo requirements, enhanced upload progress, and navigation options.

An enhanced matching system incorporates a comprehensive interests system with 80+ predefined interests and extended preference fields. A weighted scoring algorithm (v2) calculates compatibility for Discovery and Daily Picks APIs, considering shared interests, relationship goals, lifestyle, activity, and tier similarity. The Discovery UI displays compatibility percentages, "Likes You" indicators, bio previews, and shared interests. All preferences, weights, and interests are centrally configured.

**Mobile App UX Enhancements (November 1, 2025):** The mobile application now features full parity with the web app experience. Profile viewing pages (`/profile/[userId]`) display comprehensive information for informed matching decisions including membership tier badge, online status indicator, bio, interests (purple chips), Personal Details section (gender, orientation, looking for, relationship goals, height, body type, education), and Lifestyle section (drinking, smoking, exercise, religion, children, pets). All sections use conditional rendering to hide when no data exists, preventing empty section headers. The page includes a back button (ArrowLeft icon) in the header, allowing users to escape profile view without being forced to make a Like/Pass decision. Discovery cards are tappable to view full profiles, with a "Tap to view full profile" hint overlay (translucent bottom overlay) to improve discoverability. The Profile tab is now fully editable, allowing users to modify all onboarding data (photos, video, bio, interests, all 13 preferences) directly from the Profile page. Smart media handling loads existing photos/videos from database and marks them as existing to prevent re-upload during save operations. The save flow shows a success Alert and reloads fresh data instead of navigating away, maintaining user context. The subscription page back button correctly navigates to `/(tabs)/profile` ensuring users don't get stuck. All routing flows preserve navigation integrity while enabling browse-without-action functionality.

**6-Tab Navigation System (November 1, 2025):** The mobile app now features complete navigation parity with the web application through a 6-tab bottom navigation system. Tab structure: (1) Discovery - main swipe interface with quick access buttons to Daily Picks and Profile Viewers, (2) New Matches - displays recent unviewed matches with real-time badge counter showing count (max "9+"), refreshing every 30 seconds using shared query state, (3) Matches - all matched users with access to Likers sub-page, (4) Messages - chat conversations, (5) Membership - self-contained tier comparison displaying all 4 tiers (Free, Casual, Dating, Business) with features, pricing, current plan indicator, and inline upgrade buttons; only Stripe checkout navigates externally (required for payment processing), (6) Profile - user profile management. All tabs maintain tab navigator context, keeping bottom tabs visible at all times during browsing. Quick access buttons in Discovery provide direct navigation to Daily Picks (curated compatible profiles) and Profile Viewers (reverse discovery showing who viewed your profile in last 7 days). Complete aesthetic uniformity achieved across mobile and web: consistent colors (#5B3BAF primary, #00BFA6 secondary), Inter font family, spacing (16px padding, 12-16px border radius), shadows (0.1 opacity, elevation 3), and card styling (white backgrounds, subtle borders). New features added: `(tabs)/new-matches.jsx`, `(tabs)/membership.jsx`, `daily-picks.jsx`, `profile-viewers.jsx`. Badge system uses real-time queries with 30s refresh intervals, displaying unviewed match counts in secondary color with proper positioning on tab icons.

**Mobile API Integration Fixes (November 3, 2025):** The mobile app now uses a centralized `apiFetch` helper (`mobile/src/utils/api/apiFetch.js`) that automatically adds the backend base URL and credentials to all API requests, resolving 401 authentication errors. All media URLs (photos and videos) are converted to absolute URLs using the `getAbsoluteUrl()` helper before being passed to React Native Image and VideoView components, ensuring proper media loading across all screens (Discovery, Profile Viewer, Daily Picks, Matches, Messages, New Matches, Profile Viewers). Backend endpoints `/api/matches/list` and `/api/blockers` updated to use `getAuthenticatedUserId()` helper for consistent QA_BYPASS authentication support across the application.

**Comprehensive Media URL Handling (November 4, 2025):** Completed comprehensive audit and fix of all image/video rendering components across both mobile and web applications to ensure proper URL handling. Web app now includes `urlHelpers.js` utility with `getAbsoluteUrl()` function that handles absolute URLs (http/https pass-through), API-prefixed paths (pass-through), and relative object storage paths (adds /api prefix). Fixed 11 total files: 8 web components (discovery, profile-viewers, matches, daily-picks, new-matches, matches/likers, messages, profile/[userId]) and 3 mobile components (matches/likers, settings/blockers, new-matches). All user photo and video URLs are now normalized before rendering, preventing 404 errors and authentication issues from relative paths. Mobile components use existing `getAbsoluteUrl()` from `apiFetch.js`, web components use new shared utility from `urlHelpers.js`. This ensures consistent media loading behavior across all platforms and screens.

**Profile Availability Controls & Preview (November 4, 2025):** Implemented comprehensive user availability controls across both web and mobile platforms, providing users granular control over their visibility and communication preferences. The system now includes three independent toggles in profile settings: (1) **Show as Online** (`immediate_available`) - displays real-time online status to other users with green indicator badge, (2) **Appear Offline (Override)** (`availability_override`) - hides online status even when active, providing privacy control, (3) **Accept Video Calls** (`video_call_available`) - separate toggle allowing users to opt-in/out of video call requests independent of online status, preventing unwanted interruptions. All three settings are persisted server-side via `/api/profile` PUT endpoint and synchronized across platforms. The chat interface (`/messages/[matchId]`) now respects the `video_call_available` status of the match partner - when disabled, the "Start Video Call" button is replaced with a greyed-out "Video Calls Unavailable" indicator, preventing call initiation and providing clear communication. Database schema updated with `video_call_available` boolean column (defaults to `true` for existing users). Additionally, both platforms now feature a **Profile Preview** page (web: `/profile/preview`, mobile: `/profile-preview`) accessible via button from profile settings, allowing users to see exactly how their profile appears to other users before making changes public. The preview page displays all profile sections (photos, video, bio, interests, personal details, lifestyle) in read-only format matching the exact presentation shown in discovery and profile viewing flows. Both preview pages include functional back buttons ensuring users can easily return to editing without navigation issues. This feature set provides essential privacy controls and confidence-building tools for user engagement.

## External Dependencies
- **Database**: PostgreSQL (Neon serverless)
- **Authentication**: Auth.js
- **Payment**: Stripe
- **Video Conferencing**: Daily.co
- **Object Storage**: Replit Object Storage
- **Frontend Framework**: React 18
- **Frontend Router**: React Router 7
- **Styling**: TailwindCSS
- **Backend Framework**: Hono (Node.js)